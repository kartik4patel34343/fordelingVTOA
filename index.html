<!doctype html>
<html>
    <head>
        <meta charset="utf-8">

        <title>fordelingVTOA</title>
        <link rel='stylesheet' id='responsive-style-css'  href='http://www.studentvelferd.no/wp-content/themes/responsive/style.css?ver=1.9.3.4' type='text/css' media='all' />
        <link rel='stylesheet' id='responsive-media-queries-css'  href='http://www.studentvelferd.no/wp-content/themes/responsive/core/css/style.css?ver=1.9.3.4' type='text/css' media='all' />
        <link rel='stylesheet' id='responsive-child-style-css'  href='http://www.studentvelferd.no/wp-content/themes/velferdstinget-responsive/style.css?ver=1.9.3.4' type='text/css' media='all' />
        <style type="text/css">
#studentNumbers div {
    background-color: #aaa 
}
        </style>.
<!--        <script type="text/javascript" src="jquery-1.11.2.min.js"></script> -->
        <script type="text/javascript" src="raphael-min.js"></script>
        <script type="text/javascript" src="csv_parse.js"></script>
        <script type="text/javascript" src="render.js"></script>
        <script type="text/javascript" src="saint_lague.js"></script>
        <script type="text/javascript" src="fordeling.js"></script>
        <script type="text/javascript">
var f = new Fordeling();

function myAddField() {
    f.r.addField();
}

function isWellformed( f ) {
    if ( f.indexOf( String.fromCharCode(65533) ) >= 0 ) {
        // this will be true if you encounter a non-ascii latin1 character
        // in data you've read as utf-8. don't ask me why.
        console.log("File is not well formed");
        return false;
    }
    console.log("file is good");
    return true;
}

function startRead() {  
    // find the file-input element

    var file = document.getElementById('filet').files[0];
    if(file){
        getAsText(file, "UTF-8");
    }
}

function startReadLatin1() {
    var file = document.getElementById('filet').files[0];
    if(file){
        getAsText(file, "iso-8859-1");
    }
}

function getAsText(readFile, encoding) {

    var reader = new FileReader();

    // Read file into memory as UTF-8      
    reader.readAsText(readFile, encoding);

    // Handle progress, success, and errors
    reader.onprogress = updateProgress;
    reader.onload = loaded;
    reader.onerror = errorHandler;
}

function updateProgress(evt) {
    /*
    // You could do something here
    if (evt.lengthComputable) {
        // evt.loaded and evt.total are ProgressEvent properties
        var loaded = (evt.loaded / evt.total);
        if (loaded < 1) {
            // Increase the prog bar length
            // style.width = (loaded * 200) + "px";
        }
    }
    */
}

function loaded(evt) {  
    // Get the read file data    
    if ( isWellformed( evt.target.result ) ) {
        f.initiateFromData( evt.target.result );
    } else {
        startReadLatin1();
    }
}

function errorHandler(evt) {
  if(evt.target.error.name == "NotReadableError") {
    // The file could not be read
  }
}

// PIE CHART FUCK YEAH

Raphael.fn.pieChart = function (cx, cy, r, values, labels, stroke) {
    var paper = this,
        rad = Math.PI / 180,
        chart = this.set();
    function sector(cx, cy, r, startAngle, endAngle, params) {
        var x1 = cx + r * Math.cos(-startAngle * rad),
            x2 = cx + r * Math.cos(-endAngle * rad),
            y1 = cy + r * Math.sin(-startAngle * rad),
            y2 = cy + r * Math.sin(-endAngle * rad);
        return paper.path(["M", cx, cy, "L", x1, y1, "A", r, r, 0, +(endAngle - startAngle > 180), 0, x2, y2, "z"]).attr(params);
    }
    var angle = 0,
        total = 0,
        start = 0,
        process = function (bcolor, label, value) {
            var 
                angleplus = 360 * value / total,
                popangle = angle + (angleplus / 2),
                color = Raphael.hsb(start, .75, 1),
                ms = 500,
                delta = 30,
                /* bcolor = Raphael.hsb(start, 1, 1), */
                p = sector(cx, cy, r, angle, angle + angleplus, {fill: bcolor, stroke: stroke, "stroke-width": 3}),
                txt = paper.text(cx + (r + delta + 55) * Math.cos(-popangle * rad), cy + (r + delta + 25) * Math.sin(-popangle * rad), label).attr({fill: bcolor, stroke: "none", opacity: 0, "font-size": 20});
            p.mouseover(function () {
                p.stop().animate({transform: "s1.1 1.1 " + cx + " " + cy}, ms, "elastic");
                txt.stop().animate({opacity: 1}, ms, "elastic");
            }).mouseout(function () {
                p.stop().animate({transform: ""}, ms, "elastic");
                txt.stop().animate({opacity: 0}, ms);
            });
            angle += angleplus;
            chart.push(p);
            chart.push(txt);
            start += .1;
        };
    for (var i = 0, ii = values.length; i < ii; i++) {
        total += values[i];
    }
    var colors = [];
    for (i = 0; i < values.length; ++i ) {
        colors.push(Raphael.hsb( 1 / values.length * i, 0.8, 0.9) );
    }
    /* values.map( function( a ) { return Raphael.hsb( a / 37, 1, 1); }); */

    for (i = 0; i < ii; i++) {
        for (var k = values[i]; k > 0; --k) {
            process(colors[i], labels[i], 1);
        }
    }
    return chart;
};

function drawdatgraph () {
    var paper = Raphael("graphicalRepresentation", 700, 700);
        paper.pieChart(350, 350, 200, f.s.seats.map(function( x ){ return x[0]}),
                f.s.seats.map(function( x ){ return x[1]}),
                "#fff");
        paper.circle(350,350,130).attr({"fill": "#fff", "stroke": "#fff"});
        paper.image("VT-logo_bw.svg", 245,260, 240,180 );
        paper.setViewBox(0,0,700,700, true);
        paper.setSize("100%","100%");

}
        </script>


    </head>
    <body>
        <div style="max-width:35em;margin-left:auto;margin-right:auto;">
        <p><a href="doc">Hvordan bruke denne siden</a></p>


        <form id="csvDisBitch">
            <label>Last opp en .csv</label><input type="file" id="filet" onchange="startRead()"/>
            <!-- don't need this:
                <input type="button" value="Last inn" onclick="startRead()"/>
            -->
            <input type="button" value="Beregn valgforsamling" onclick="f.wash()"/>
            <input type="button" value="Beregn mandater" onclick="f.election()"/>
            <input type="button" value="Tegn" onclick="drawdatgraph()"/>
        </form>
        <!--
        <span> eller </span>
        <select id="chooseData">
            <option>Velg et datasett</option>
        </select> -->

        <hr />

        <form method="get" id="studentCount">
            <div id="studentNumbers">
            </div>
            <br />
            <input type="button" onclick="myAddField()" value=" + " />
            <br />
        </form>

        <p id="notProcessBox"
        onclick="document.getElementById('processbox').style.display='block';this.style.display='none'"><strong>Klikk for 책 vise stemmetellingen</strong></p>
        <div style="display:none;background-color:#ccc;" id="processbox"
            ondblclick="document.getElementById('notProcessBox').style.display='block';document.getElementById('processbox').style.display='none'"
            title="Dobbeltklikk for 책 lukke"></div>

        <h3>Resultat</h3>
        <div id="resultbox"></div>
        <p id="notvalgforsamling"
        onclick="document.getElementById('valgforsamling').style.display='block';this.style.display='none'"><strong>Valgforsaming (klikk
            for 책 vise)</strong></p>
        <div style="display:none;font-size:smaller;" id="valgforsamling"
            ondblclick="document.getElementById('notvalgforsamling').style.display='block';document.getElementById('valgforsamling').style.display='none'"
            title="Dobbeltklikk for 책 lukke"></div>
        <div id="graphicalRepresentation" >
        </div>
        </div>
    </body>
</html>
